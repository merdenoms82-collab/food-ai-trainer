-- Add new columns to training_data if they don't exist
ALTER TABLE training_data 
ADD COLUMN IF NOT EXISTS confidence FLOAT,
ADD COLUMN IF NOT EXISTS image_url TEXT,
ADD COLUMN IF NOT EXISTS category TEXT;

-- Create users table if it doesn't exist
CREATE TABLE IF NOT EXISTS users (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    session_id TEXT UNIQUE,
    email TEXT,
    total_photos INTEGER DEFAULT 0,
    total_corrections INTEGER DEFAULT 0,
    xp INTEGER DEFAULT 0,
    level INTEGER DEFAULT 1,
    streak INTEGER DEFAULT 0,
    last_active DATE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW())
);

-- Create daily_challenges table
CREATE TABLE IF NOT EXISTS daily_challenges (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    category TEXT,
    target INTEGER,
    reward INTEGER,
    icon TEXT,
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW())
);

-- Insert sample challenges
INSERT INTO daily_challenges (name, description, category, target, reward, icon) VALUES
('Fruit Finder', 'Identify 3 different types of fruits', 'FRUITS', 3, 150, 'fas fa-apple-alt'),
('Veggie Master', 'Identify 5 different vegetables', 'VEGETABLES', 5, 250, 'fas fa-carrot'),
('Protein Pro', 'Identify 4 different protein sources', 'PROTEINS', 4, 200, 'fas fa-drumstick-bite');

-- Create user_progress table
CREATE TABLE IF NOT EXISTS user_progress (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    challenge_id UUID REFERENCES daily_challenges(id),
    progress INTEGER DEFAULT 0,
    completed BOOLEAN DEFAULT false,
    completed_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()),
    UNIQUE(user_id, challenge_id)
);

-- Create achievements table
CREATE TABLE IF NOT EXISTS achievements (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    name TEXT NOT NULL,
    description TEXT,
    icon TEXT,
    requirement INTEGER,
    xp INTEGER,
    tier TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW())
);

-- Insert achievements
INSERT INTO achievements (name, description, icon, requirement, xp, tier) VALUES
('First Photo', 'Take your first training photo', 'fas fa-camera', 1, 50, 'bronze'),
('Food Expert', 'Train 10 different food items', 'fas fa-utensils', 10, 200, 'silver'),
('AI Trainer', 'Submit 25 photos total', 'fas fa-robot', 25, 500, 'gold'),
('Correction Master', 'Correct the AI 5 times', 'fas fa-edit', 5, 300, 'silver');

-- Create user_achievements table
CREATE TABLE IF NOT EXISTS user_achievements (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES users(id),
    achievement_id UUID REFERENCES achievements(id),
    unlocked BOOLEAN DEFAULT false,
    unlocked_at TIMESTAMP WITH TIME ZONE,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()),
    UNIQUE(user_id, achievement_id)
);
